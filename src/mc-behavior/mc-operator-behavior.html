<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
  Polymer.McOperatorBehavior = {
    properties: {
      inGame: {
        type: Boolean,
        notify: true,
        value: true
      },

      blockArray: {
        notify: true
      },

      cacheArray: {
        type: Array,
        notify: true,
        value: []
      },

      leftNumber: {
        type: Number,
        notify: true,
        observer: '_observerLeftNumber'
      }
    },

    // 鼠标点击事件
    blockClick: function(e) {
      if (this.inGame) {
        var mcBlock = e.target;
        var mineNumber = mcBlock.mineNumber;
        var btnNum = e.button;

        // 第一次点击，获取block DOM数组
        if (!this.blockArray) {
          this._getBlockArray();
        }

        // 判断鼠标的点击是否为左键
        if (btnNum == 0 && !mcBlock.isMark) {
          // 呈现雷数目
          mcBlock.isOpen = true;

          // 踩到雷
          if (mineNumber === -1) {
            this.inGame = false;
            this.openFailTipper();
          }

          // 周围雷数目为0
          if (mineNumber === 0) {
            this.exposeZeroAroundBlock(mcBlock.blockXy);
          }

          if (this.judgeTheGameIsEnd()) {
            this.leftNumber = 0;
            this.inGame = false;
            this.openVictoryTipper();
          }
        }

        // 右键标记这里有雷
        if (btnNum === 2 && !mcBlock.isOpen) {
          mcBlock.markStatus++;
          return mcBlock.markStatus === 1 ? this.leftNumber-- : this.leftNumber++;
        }

      }
    },

    // 获取block数组
    _getBlockArray: function() {
      this.blockArray = this.$.table.querySelectorAll('mc-block');
    },

    // 揭露雷数目为0的周围block
    exposeZeroAroundBlock: function(blockXy) {
      if (this.inGame) {
        var x = blockXy.x;
        var y = blockXy.y;
        xy = x * this.width + y;

        for (var m = x - 1; m <= (x + 1); m++) {
          for (var n = y - 1; n <= (y + 1); n++) {
            if (m > -1 && n > -1 && n < this.width) {
              var k = m * this.width + n;
              if (m >= 0 && m < this.height && n >= 0 && n < this.width && k != xy) {
                this.blockArray[k].isOpen = true;
              }
            }
          }
          n = y -1;
        }
      }
    },

    // 揭露周围block
    exposeAroundBlock: function(blockXy) {
      if (this.inGame) {
        var x = blockXy.x;
        var y = blockXy.y;
        xy = x * this.width + y;

        for (var m = x - 1; m <= (x + 1); m++) {
          for (var n = y - 1; n <= (y + 1); n++) {
            if (m > -1 && n > -1 && n < this.width) {
              var k = m * this.width + n;
              if (m >= 0 && m < this.height && n >= 0 && n < this.width && k != xy && !this.blockArray[k].isMark) {
                this.blockArray[k].isOpen = true;
                if (this.blockArray[k].mineNumber === -1) {
                  this.isGame = false;
                  this.openFailTipper();
                }
              }
            }
          }
          n = y -1;
        }
      }
    },

    // 重新开始
    reset: function() {
      for (var key in this.blockArray) {
        if (this.blockArray.hasOwnProperty(key)) {
          this.blockArray[key].isOpen = false;
          this.blockArray[key].isMark = false;
          this.blockArray[key].markStatus = 0;
        }
      }
      this.inGame = true;
      this.leftNumber = this.mineNumber;
    },

    // 判断游戏是否结束
    judgeTheGameIsEnd: function() {
      if (this.inGame) {
        var blockArray = this.blockArray;
        var total = this.width * this.height;
        var count = 0;

        for (var key in this.blockArray) {
          if (blockArray.hasOwnProperty(key)) {
            if (blockArray[key].isOpen) {
              count++;
            }
          }
        }

        if (count + this.mineNumber === total) {
          return true;
        }

        return false;
      }
    },

    openVictoryTipper: function() {
      this.$.victoryTipper.open();
    },

    openFailTipper: function() {
      this.$.failTipper.open();
    }
  }
</script>
